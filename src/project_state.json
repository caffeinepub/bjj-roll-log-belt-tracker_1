{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 3,
  "summary": "Jiu-Jitsu Journey is an Internet Computer (ICP) dapp for tracking Brazilian Jiu-Jitsu training. A Motoko backend canister stores per-user data keyed by Principal (profiles, belt progress, training sessions, techniques, submission logs, and per-day training-hour overrides) behind role-based access control. A React + TypeScript frontend authenticates via Internet Identity, initializes a typed backend actor, and provides a tabbed dashboard to create/edit a profile, log and edit training sessions, track belt/stripe progression with gamified stats, maintain a multi-belt submission log with searchable add flow, browse a personal technique library, and visualize training volume via a month calendar and yearly heat map. The frontend uses TanStack React Query for caching/mutations with toast feedback, next-themes for theming, and includes a debug overlay for initialization diagnostics.",
  "existing_features": [
    {
      "id": "IF-1",
      "title": "Internet Identity authentication provider",
      "synonyms": [
        "InternetIdentityProvider",
        "useInternetIdentity",
        "AuthClient integration"
      ],
      "description": "Provides login/logout via Internet Identity using @dfinity/auth-client, restores existing authenticated identity on mount, and exposes detailed login/identity status via React context.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-2",
      "title": "Backend actor initialization wrapper with step tracking and diagnostics",
      "synonyms": [
        "useActorWrapper",
        "actorReady",
        "InitStep",
        "getActorInitLogs"
      ],
      "description": "Creates anonymous or authenticated backend actors based on identity, tracks initialization steps (auth → identity → actor create → ready), and logs progress/warnings to a global in-memory buffer used by the debug overlay.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-3",
      "title": "Secret token extraction from URL hash with session persistence",
      "synonyms": [
        "getSecretParameter",
        "getSecretFromHash",
        "urlParams utilities"
      ],
      "description": "Reads sensitive parameters (e.g., caffeineAdminToken) from the URL hash, persists them in sessionStorage, and removes them from the URL via history.replaceState to reduce leakage via history/referrers.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-4",
      "title": "Backend role-based access control (RBAC) with admin bootstrap and role assignment",
      "synonyms": [
        "authorization/access-control",
        "MixinAuthorization",
        "_initializeAccessControlWithSecret",
        "assignCallerUserRole"
      ],
      "description": "Motoko authorization layer supports #admin/#user/#guest roles; initialization uses an env-provided admin token plus a caller-provided secret; includes admin checks and admin-only role assignment.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-5",
      "title": "Centralized React Query hook layer for backend reads/writes",
      "synonyms": [
        "useQueries",
        "TanStack Query data layer"
      ],
      "description": "Typed queries/mutations for profiles, registration, training sessions, belt progress, techniques, custom technique types, theme preference, training hours, and submission logs; includes cache invalidation patterns and toast feedback.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-6",
      "title": "User profile registration and persistence APIs",
      "synonyms": [
        "register",
        "getCallerUserProfile",
        "saveCallerUserProfile",
        "saveExtendedProfile"
      ],
      "description": "Backend supports per-user profile creation and updates including username, belt progress, optional profile picture blob, optional gym info, optional practitioner-since timestamp, and additional profile fields (bio/nickname/goals/milestones/theme preference).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-7",
      "title": "Profile setup and edit UI",
      "synonyms": [
        "ProfileSetup",
        "avatar upload",
        "gym favicon detection",
        "practitioner-since selector"
      ],
      "description": "Profile creation/edit form supporting username, belt/stripes selection with belt preview image, profile picture upload converted to ExternalBlob, gym info (name/location/optional website favicon), and practitioner-since month/year selection.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-8",
      "title": "App shell with conditional routing based on auth, actor readiness, and profile existence",
      "synonyms": [
        "App.tsx",
        "ProfileSetup gating",
        "Dashboard gating"
      ],
      "description": "Coordinates Internet Identity initialization, actor readiness, and profile loading; routes users to login, profile setup (if missing), or main dashboard; supports in-app profile editing mode.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-9",
      "title": "Header with profile access, theme toggle, debug mode toggle, and logout",
      "synonyms": [
        "Header",
        "next-themes",
        "bjj-theme",
        "bjj-debug-mode"
      ],
      "description": "Provides branding, responsive profile entry point, local-first theme toggling with optional backend persistence, debug-mode toggle stored in localStorage (page reload to apply), and logout that clears identity and React Query cache.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-10",
      "title": "Training session persistence APIs (per-user)",
      "synonyms": [
        "getTrainingRecords",
        "addTrainingRecord",
        "saveTrainingRecords"
      ],
      "description": "Backend stores per-user training sessions and supports fetching sessions, adding a session, and overwriting all sessions (used for edits). Sessions include date, duration, gi/no-gi, theme, intensity, mood rating, rolls, and belt snapshot.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-11",
      "title": "Training session logging and editing dialog",
      "synonyms": [
        "AddTrainingDialog",
        "week-view date picker",
        "mood slider",
        "intensity selector"
      ],
      "description": "Dialog UI to create/edit sessions with week-based date selection, duration quick-select and 0.25h increments, gi/no-gi toggle, theme selection, rolls and intensity inputs, and a mood slider that stores moodRating on a 0–1 scale; stores dates at local midnight (ms→ns) and snapshots belt progress.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-12",
      "title": "Training Log page with month calendar, submission log, and analytics charts",
      "synonyms": [
        "TrainingLog",
        "Weekly Activity chart",
        "Theme Frequency chart"
      ],
      "description": "Training Log combines the month-view calendar, an always-visible submission log section, and analytics cards/charts (weekly sessions bar chart and session theme frequency pie chart) with entry points to log and edit sessions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-13",
      "title": "Month-view training calendar with click-to-jump details panel and drag-to-scroll",
      "synonyms": [
        "TrainingMonthCalendar",
        "click-to-scroll highlight",
        "useDragToScroll",
        "mood icons"
      ],
      "description": "Month calendar groups sessions by local date, styles day cells by training type (Gi blue, No-Gi red, mixed purple), supports clicking a day to scroll the details list to the first session and highlight it, and shows each session with intensity/theme badges and mood icon in a scrollable details panel.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-14",
      "title": "Submission log backend model and APIs (multi-belt)",
      "synonyms": [
        "SubmissionLog",
        "getSubmissionLog",
        "saveSubmissionLog",
        "getSubmissionCountsByBelt",
        "hasBeltSubmission"
      ],
      "description": "Backend stores per-user submission counts grouped by belt (white/blue/purple/brown/black), returns an empty default if missing, and merges duplicate submission names case-insensitively on save.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-15",
      "title": "Submission log UI with opponent belt selector, dirty-check save, and expand/collapse list",
      "synonyms": [
        "SubmissionLogSection",
        "belt selector dropdown",
        "show more/less"
      ],
      "description": "Frontend maintains a local multi-belt submission log, defaults selected opponent belt to the user’s current belt, supports switching belt groups, adding/removing submissions, normalizes duplicates, expands/collapses long lists, and only shows Save when local state differs from backend state.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-16",
      "title": "Searchable submission selector with keyboard navigation",
      "synonyms": [
        "SubmissionSelectInput",
        "popover search",
        "SUBMISSION_OPTIONS"
      ],
      "description": "Popover-based dropdown for adding submissions with live filtering, keyboard navigation (up/down/enter/escape), reliable focus handling, and exclusion of already-selected submissions (case-insensitive).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-17",
      "title": "Submission log normalization and CRUD utilities",
      "synonyms": [
        "submissionLogUtils",
        "normalizeSubmissionName",
        "mergeDuplicates",
        "add/remove/increment/decrement"
      ],
      "description": "Utility functions for case-insensitive normalization, duplicate detection/merging, and CRUD operations for submission entries in a belt grouping.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-18",
      "title": "Belt progress persistence APIs and belt tracker UI",
      "synonyms": [
        "getBeltProgress",
        "updateBeltProgress",
        "BeltTracker",
        "belt ladder"
      ],
      "description": "Users can fetch/update belt progress; UI displays current belt/stripes with belt images, allows updating belt/stripes, and renders a belt ladder with completed/current/next/locked visual states.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-19",
      "title": "Gamified belt progression stats (client-side)",
      "synonyms": [
        "calculateBeltGamifiedStats",
        "progress bars",
        "submission thresholds"
      ],
      "description": "Computes belt stats from sessions and submission log for the current belt: progression percent (stripes + hour milestones), experience curve (hours), unique-submission proficiency with belt thresholds, and technique mastery based on theme coverage.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-20",
      "title": "Technique library backend APIs and per-user storage",
      "synonyms": [
        "Technique",
        "getTechniques",
        "addTechnique",
        "getAllTechniques"
      ],
      "description": "Backend stores per-user techniques (name, SessionTheme category, type string, description, link, optional thumbnail blob, tags, linked session IDs) and supports user-scoped fetch/add plus admin aggregation across all users.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-21",
      "title": "Technique library UI with search, category filtering, and add dialog",
      "synonyms": [
        "TechniqueLibrary",
        "AddTechniqueDialog",
        "category tabs",
        "YouTube thumbnail preview"
      ],
      "description": "Technique Library page provides full-text search and SessionTheme-based category tabs, card-based technique display, and an add dialog with tags and automatic YouTube thumbnail preview generation for links.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-22",
      "title": "Custom technique type storage APIs",
      "synonyms": [
        "getCustomTechniqueTypes",
        "addCustomTechniqueType"
      ],
      "description": "Backend and query hooks support per-user creation and retrieval of custom technique type names.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-23",
      "title": "Theme preference persistence",
      "synonyms": [
        "updateThemePreference",
        "next-themes integration"
      ],
      "description": "Theme toggle updates UI immediately (localStorage-backed via next-themes) and asynchronously persists the preference to the backend when authenticated.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-24",
      "title": "Yearly training heat map visualization (session-derived)",
      "synonyms": [
        "TrainingHeatMap",
        "GitHub-style heatmap",
        "local date mapping"
      ],
      "description": "Displays a yearly heat map of daily training hours aggregated from sessions using local-date mapping, explicit Monday→Sunday rows, and theme-aware empty-cell colors with instant recalculation on theme changes.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-25",
      "title": "Manual training-hours overrides APIs and editable heat map component",
      "synonyms": [
        "TrainingHoursHeatMap",
        "setTrainingHours",
        "clearTrainingHours",
        "getAllTrainingHours"
      ],
      "description": "Backend supports per-day training hour records and batch operations; frontend includes an editor heat map that merges session-derived hours with manual overrides and provides date/hour inputs with 0.25-hour increments and save/clear actions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-26",
      "title": "Image caching and asset preloading",
      "synonyms": [
        "CachedImage",
        "imageCache",
        "preloadAllBeltImages"
      ],
      "description": "In-memory image preloading/caching and a CachedImage component with fallback handling; belt images are preloaded to reduce flicker and improve navigation smoothness.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-27",
      "title": "Mood and intensity display utilities",
      "synonyms": [
        "intensityUtils",
        "moodIcons",
        "badge color helpers"
      ],
      "description": "Standardized intensity labels/short codes/badge classes and mood helpers that map mood ratings (0–1) to canonical labels and generated asset paths, with clamping and safe fallbacks.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-28",
      "title": "Debug overlay for auth/actor/profile diagnostics",
      "synonyms": [
        "DebugOverlay",
        "init progress panel",
        "actor log viewer"
      ],
      "description": "Toggleable debug panel showing actor initialization progress, warnings/errors, Internet Identity status, profile fetch status, elapsed time, and live initialization logs with severity highlighting.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-29",
      "title": "Admin/system reporting endpoints",
      "synonyms": [
        "getSystemStatus",
        "getUserProfilesCount",
        "getAllUsersTrainingHours"
      ],
      "description": "Admin-only backend endpoints for basic system status and aggregated training-hours reporting across users.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-30",
      "title": "Caffeine blob-storage maintenance and cycles refill endpoints",
      "synonyms": [
        "_caffeineStorageUpdateGatewayPrincipals",
        "_caffeineStorageBlobsToDelete",
        "_caffeineStorageConfirmBlobDeletion",
        "_caffeineStorageRefillCashier"
      ],
      "description": "Backend exposes maintenance endpoints for authorized blob-gateway principals (dead-blob listing/pruning, live checks), certificate metadata helper, and cashier refill operations guarded by a cashier principal.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-31",
      "title": "Deployment and smoke-check documentation templates (Draft versions)",
      "synonyms": [
        "REBUILD_DEPLOY_*",
        "SMOKE_CHECK_*",
        "REDEPLOY_NOTE_*"
      ],
      "description": "Markdown templates/checklists documenting clean rebuild/redeploy procedures and post-deployment smoke checks across multiple draft versions, including structured failure reporting fields.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "feature-update-the-profile-analytics-page-frontend-src-components-profileanalytics-tsx-so-the-training-statistics-section-displays-6-metrics-instead-of-the-current-4-using-the-existing-per-user-training-sessions-data-and-submission-log-data-1-total-sessions-count-of-sessions-2-total-training-time-sum-of-session-duration-converted-to-hours-3-total-rolls-sum-of-session-rolls-4-submissions-learned-count-of-unique-submission-names-achieved-at-blue-belt-and-above-derived-from-the-user-submission-log-arrays-for-blue-purple-brown-black-5-favorite-theme-most-frequent-sessiontheme-across-sessions-displayed-using-the-existing-theme-label-formatter-and-6-average-intensity-average-of-session-intensity-across-sessions-using-a-consistent-numeric-mapping-and-displayed-as-a-label",
      "title": "Update the Profile Analytics page (frontend/src/components/ProfileAnalytics.tsx) so the \"Training Statistics\" section displays 6 metrics (instead of the current 4), using the existing per-user training sessions data and submission log data: (1) Total Sessions (count of sessions), (2) Total Training Time (sum of session duration converted to hours), (3) Total Rolls (sum of session.rolls), (4) Submissions Learned (count of unique submission names achieved at blue belt and above, derived from the user submission log arrays for blue/purple/brown/black), (5) Favorite Theme (most frequent sessionTheme across sessions, displayed using the existing theme label formatter), and (6) Average Intensity (average of session.intensity across sessions, using a consistent numeric mapping and displayed as a label).",
      "reqIds": [
        "REQ-1"
      ],
      "version": 1
    },
    {
      "id": "feature-update-the-training-log-analytics-section-frontend-src-components-traininglog-tsx-so-it-provides-6-analytics-visualizations-instead-of-the-current-4-based-on-existing-trainingsession-fields-trainingtype-sessiontheme-rolls-intensity-moodrating-duration-date-1-gi-vs-no-gi-ratio-as-a-pie-chart-showing-percentage-of-sessions-by-trainingtype-2-session-theme-frequency-as-a-pie-chart-showing-distribution-of-themes-practiced-3-average-rolls-per-session-as-a-time-trend-chart-4-intensity-trends-over-time-as-a-line-chart-over-time-average-intensity-per-time-bucket-5-mood-vs-intensity-correlation-as-a-scatter-plot-moodrating-vs-intensity-numeric-and-6-weekly-monthly-training-volume-as-a-bar-chart-showing-total-hours-or-sessions-per-week-month-include-a-simple-toggle-for-weekly-vs-monthly-and-hours-vs-sessions-or-otherwise-clearly-support-both-weekly-monthly-and-hours-sessions-without-adding-backend-apis",
      "title": "Update the Training Log analytics section (frontend/src/components/TrainingLog.tsx) so it provides 6 analytics visualizations (instead of the current 4), based on existing TrainingSession fields (trainingType, sessionTheme, rolls, intensity, moodRating, duration, date): (1) Gi vs No-Gi Ratio as a pie chart showing percentage of sessions by trainingType, (2) Session Theme Frequency as a pie chart showing distribution of themes practiced, (3) Average Rolls per Session as a time trend chart, (4) Intensity Trends Over Time as a line chart over time (average intensity per time bucket), (5) Mood vs Intensity Correlation as a scatter plot (moodRating vs intensity numeric), and (6) Weekly / Monthly Training Volume as a bar chart showing total hours or sessions per week/month (include a simple toggle for Weekly vs Monthly and Hours vs Sessions, or otherwise clearly support both weekly/monthly and hours/sessions without adding backend APIs).",
      "reqIds": [
        "REQ-2"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-1",
      "summary": "Expand analytics: Profile Analytics Training Statistics from 4→6 metrics (Total Sessions, Total Training Time, Total Rolls, Submissions Learned (unique on blue+ belts), Favorite Theme, Average Intensity) and Training Log analytics to 6 visualizations (Gi vs No-Gi ratio pie, Theme frequency pie, Avg rolls/session trend, Intensity trend line, Mood vs Intensity correlation, Weekly/Monthly training volume bar).",
      "reqIds": [],
      "status": "pending"
    }
  ],
  "architectural_notes": [
    "Internet Computer architecture: Motoko backend canister exposes query/shared methods; frontend calls through a generated typed actor interface (frontend/src/backend.d.ts).",
    "Backend uses in-memory mo:core/Map structures keyed by Principal for user-scoped storage (non-stable; redeploy/upgrade loses data).",
    "Backend composes cross-cutting concerns using Motoko mixins (authorization RBAC + blob-storage maintenance endpoints).",
    "Frontend uses React + TypeScript with TailwindCSS and shadcn/ui (Radix) components; lucide-react icons; Recharts for charts.",
    "TanStack React Query centralizes backend reads/writes with query keys, enabled gating on actor readiness, and cache invalidation after mutations.",
    "Authentication handled via @dfinity/auth-client and DelegationIdentity; identity is restored on reload if authenticated.",
    "Actor initialization is wrapped in a custom hook that tracks linear init steps and writes to a global in-memory log buffer consumed by DebugOverlay.",
    "Date handling is intentionally local-time based; sessions are stored at local midnight (ms→ns) and mapped to local YYYY-MM-DD for calendars/heat maps.",
    "Theme is local-first using next-themes + localStorage, with optional backend persistence via updateThemePreference.",
    "UX/performance includes image preloading and an in-memory image cache to reduce flicker (belt images, avatars, etc.)."
  ],
  "known_issues": [
    "No stable persistence in the backend; canister upgrades/redeploys will wipe user data (profiles, sessions, roles, logs, techniques, training-hours overrides).",
    "RBAC is brittle for first-time users: AccessControl.getUserRole traps for principals not registered in userRoles; ensureUserRole calls getUserRole and can therefore trap. Additionally, the frontend actor wrapper skips calling _initializeAccessControlWithSecret unless an admin token is present, so normal users may never get registered into RBAC and cannot register/use the app.",
    "Authorization initialization traps if CAFFEINE_ADMIN_TOKEN env var is missing (breaks _initializeAccessControlWithSecret).",
    "Blob-storage maintenance traps if CAFFFEINE_STORAGE_CASHIER_PRINCIPAL env var is missing (note the triple 'F' in the variable name), making configuration error-prone.",
    "Mood icon helper now returns /assets/generated/{label}.png paths, but the repo includes mood assets named *.dim_512x512.png (potential 404/missing icons unless additional .png assets exist at deploy time).",
    "Some React Query hooks intentionally swallow backend errors and return empty defaults ([], null), which can mask authorization/configuration problems without inspecting console logs.",
    "Custom technique types exist in backend + hooks, but the Technique UI 'Type' picker is wired to the hard-coded submission options list instead of custom types.",
    "TrainingHoursHeatMap (manual override editor) exists and backend supports overrides, but it is not surfaced in the main Dashboard tabs (low discoverability).",
    "Several placeholder/empty files remain (e.g., Profile.tsx, Analytics.tsx, SubmissionTagInput.tsx, useActorReady.ts, submissionsListLoader.ts), suggesting incomplete/legacy paths and potential confusion.",
    "Local-midnight timestamp storage can be affected by DST transitions in some timezones, risking occasional off-by-one-day mapping in edge cases."
  ],
  "isFixRequest": false,
  "gameProjectType": "none",
  "projectName": "Jiu-Jitsu Journey",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}